{"ast":null,"code":"var _jsxFileName = \"D:\\\\ClientProjects\\\\reactwebrtc\\\\App\\\\src\\\\App.js\",\n    _s = $RefreshSig$();\n\nimport logo from \"./logo.svg\";\nimport \"./App.css\";\nimport WebSocketClient from \"reconnecting-websocket\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst host = \"192.168.18.148:3000\";\nconst id = \"_\" + Math.random().toString(36).substr(2, 9);\nlet remoteId = null;\nlet connection = null;\n\nconst App = () => {\n  _s();\n\n  const room = \"121212\";\n  const [localStream, setLocalStream] = useState(null);\n  const [remoteStream, setRemoteStream] = useState(null); // useLayoutEffect(() => {\n  //   navigation.setOptions({headerTitle: `Room ${room}`});\n  // });\n\n  useEffect(() => {\n    const ws = new WebSocketClient(`ws://${host}`);\n\n    ws.onopen = () => {\n      console.log(\"Connected\");\n    };\n\n    ws.onerror = err => {\n      console.log(\"Got error:\", err);\n    };\n\n    ws.onmessage = async message => {\n      console.log(\"Got message:\", message);\n      const data = JSON.parse(message.data);\n\n      switch (data.type) {\n        case \"enter\":\n          await onEnter(data.success, data.full, data.wait);\n          break;\n\n        case \"offer\":\n          await onOffer(data.offer, data.remoteId);\n          break;\n\n        case \"answer\":\n          await onAnswer(data.answer);\n          break;\n\n        case \"candidate\":\n          await onCandidate(data.candidate);\n          break;\n\n        case \"leave\":\n          await onLeave();\n          break;\n\n        default:\n          break;\n      }\n    };\n\n    const send = message => {\n      message.room = room;\n\n      if (remoteId) {\n        message.remoteId = remoteId;\n      }\n\n      message.id = id;\n      ws.send(JSON.stringify(message));\n    };\n\n    const onEnter = async (success, full, wait) => {\n      if (success) {\n        if (wait) {\n          startConnection();\n        } else {\n          startConnection(true);\n        }\n      } else {\n        if (full) {//TODO: full\n        } else {//TODO:\n          }\n      }\n    };\n\n    const startConnection = (startPC = false) => {\n      const isFront = true;\n      const facingMode = isFront ? \"user\" : \"environment\";\n      const constraints = {\n        audio: true,\n        video: {\n          mandatory: {\n            minWidth: 500,\n            // Provide your own width, height and frame rate here\n            minHeight: 300,\n            minFrameRate: 30\n          },\n          facingMode\n        }\n      };\n      mediaDevices.getUserMedia(constraints).then(async stream => {\n        setLocalStream(stream);\n        await setupPeerConnection(stream, startPC);\n      }).catch(err => console.error(err));\n    };\n\n    const setupPeerConnection = async (stream, startPC = false) => {\n      const configuration = {\n        iceServers: [{\n          urls: \"stun:stun.l.google.com:19302\"\n        }]\n      };\n      const conn = new window.RTCPeerConnection(configuration);\n      connection = conn;\n      conn.addStream(stream);\n\n      conn.onaddstream = event => setRemoteStream(event.stream);\n\n      conn.onicecandidate = event => {\n        if (event.candidate) {\n          send({\n            type: \"candidate\",\n            candidate: event.candidate\n          });\n        }\n      };\n\n      if (startPC) {\n        await startPeerConnection();\n      }\n    };\n\n    const startPeerConnection = async () => {\n      try {\n        const offer = await connection.createOffer();\n        send({\n          type: \"offer\",\n          offer\n        });\n        await connection.setLocalDescription(offer);\n      } catch (err) {\n        console.error(err);\n      }\n    };\n\n    const onOffer = async (offer, remote) => {\n      remoteId = remote;\n      await connection.setRemoteDescription(new window.RTCSessionDescription(offer));\n\n      try {\n        const answer = await connection.createAnswer();\n        await connection.setLocalDescription(answer);\n        send({\n          type: \"answer\",\n          answer\n        });\n      } catch (err) {\n        console.error(err);\n      }\n    };\n\n    const onAnswer = async (answer) => await connection.setRemoteDescription(new window.RTCSessionDescription(answer));\n\n    const onCandidate = async (candidate) => await connection.addIceCandidate(new window.RTCIceCandidate(candidate));\n\n    const onLeave = async () => {\n      remoteId = null;\n      setRemoteStream(null);\n      connection.close();\n      connection.onaddstream = null;\n      connection.onicecandidate = null;\n      startConnection();\n    };\n\n    if (room.length > 0) {\n      send({\n        type: \"enter\",\n        id\n      });\n    } else {// Error\n    }\n\n    const unsubscribe = () => {\n      connection.close();\n      connection.onaddstream = null;\n      connection.onicecandidate = null;\n      send({\n        type: \"leave\"\n      });\n    };\n\n    return unsubscribe;\n  }, [navigation, room]);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"app\",\n    children: /*#__PURE__*/_jsxDEV(\"header\", {\n      className: \"App-header\",\n      children: /*#__PURE__*/_jsxDEV(\"h1\", {\n        children: \"Hi\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 197,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 196,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 195,\n    columnNumber: 5\n  }, this);\n}; // function App() {\n//   return (\n//     <div className=\"App\">\n//       <header className=\"App-header\">\n//         <img src={logo} className=\"App-logo\" alt=\"logo\" />\n//         <p>\n//           Edit <code>src/App.js</code> and save to reload.\n//         </p>\n//         <a\n//           className=\"App-link\"\n//           href=\"https://reactjs.org\"\n//           target=\"_blank\"\n//           rel=\"noopener noreferrer\"\n//         >\n//           Learn React\n//         </a>\n//       </header>\n//     </div>\n//   );\n// }\n\n\n_s(App, \"+86h9VFjDsGiYAGxtmTeeRTfsEA=\");\n\n_c = App;\nexport default App;\n\nvar _c;\n\n$RefreshReg$(_c, \"App\");","map":{"version":3,"sources":["D:/ClientProjects/reactwebrtc/App/src/App.js"],"names":["WebSocketClient","host","id","Math","random","toString","substr","remoteId","connection","App","room","localStream","setLocalStream","useState","remoteStream","setRemoteStream","useEffect","ws","onopen","console","log","onerror","err","onmessage","message","data","JSON","parse","type","onEnter","success","full","wait","onOffer","offer","onAnswer","answer","onCandidate","candidate","onLeave","send","stringify","startConnection","startPC","isFront","facingMode","constraints","audio","video","mandatory","minWidth","minHeight","minFrameRate","mediaDevices","getUserMedia","then","stream","setupPeerConnection","catch","error","configuration","iceServers","urls","conn","window","RTCPeerConnection","addStream","onaddstream","event","onicecandidate","startPeerConnection","createOffer","setLocalDescription","remote","setRemoteDescription","RTCSessionDescription","createAnswer","addIceCandidate","RTCIceCandidate","close","length","unsubscribe","navigation"],"mappings":"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","sourcesContent":["import logo from \"./logo.svg\";\nimport \"./App.css\";\nimport WebSocketClient from \"reconnecting-websocket\";\n\nconst host = \"192.168.18.148:3000\";\nconst id = \"_\" + Math.random().toString(36).substr(2, 9);\nlet remoteId = null;\nlet connection = null;\nconst App = () => {\n  const room = \"121212\";\n  const [localStream, setLocalStream] = useState(null);\n  const [remoteStream, setRemoteStream] = useState(null);\n\n  // useLayoutEffect(() => {\n  //   navigation.setOptions({headerTitle: `Room ${room}`});\n  // });\n\n  useEffect(() => {\n    const ws = new WebSocketClient(`ws://${host}`);\n\n    ws.onopen = () => {\n      console.log(\"Connected\");\n    };\n\n    ws.onerror = (err) => {\n      console.log(\"Got error:\", err);\n    };\n\n    ws.onmessage = async (message) => {\n      console.log(\"Got message:\", message);\n      const data = JSON.parse(message.data);\n      switch (data.type) {\n        case \"enter\":\n          await onEnter(data.success, data.full, data.wait);\n          break;\n        case \"offer\":\n          await onOffer(data.offer, data.remoteId);\n          break;\n        case \"answer\":\n          await onAnswer(data.answer);\n          break;\n        case \"candidate\":\n          await onCandidate(data.candidate);\n          break;\n        case \"leave\":\n          await onLeave();\n          break;\n        default:\n          break;\n      }\n    };\n\n    const send = (message) => {\n      message.room = room;\n      if (remoteId) {\n        message.remoteId = remoteId;\n      }\n      message.id = id;\n      ws.send(JSON.stringify(message));\n    };\n\n    const onEnter = async (success, full, wait) => {\n      if (success) {\n        if (wait) {\n          startConnection();\n        } else {\n          startConnection(true);\n        }\n      } else {\n        if (full) {\n          //TODO: full\n        } else {\n          //TODO:\n        }\n      }\n    };\n\n    const startConnection = (startPC = false) => {\n      const isFront = true;\n\n      const facingMode = isFront ? \"user\" : \"environment\";\n      const constraints = {\n        audio: true,\n        video: {\n          mandatory: {\n            minWidth: 500, // Provide your own width, height and frame rate here\n            minHeight: 300,\n            minFrameRate: 30,\n          },\n          facingMode,\n        },\n      };\n      mediaDevices\n        .getUserMedia(constraints)\n        .then(async (stream) => {\n          setLocalStream(stream);\n          await setupPeerConnection(stream, startPC);\n        })\n        .catch((err) => console.error(err));\n    };\n\n    const setupPeerConnection = async (stream, startPC = false) => {\n      const configuration = {\n        iceServers: [\n          {\n            urls: \"stun:stun.l.google.com:19302\",\n          },\n        ],\n      };\n      const conn = new window.RTCPeerConnection(configuration);\n      connection = conn;\n\n      conn.addStream(stream);\n      conn.onaddstream = (event) => setRemoteStream(event.stream);\n\n      conn.onicecandidate = (event) => {\n        if (event.candidate) {\n          send({\n            type: \"candidate\",\n            candidate: event.candidate,\n          });\n        }\n      };\n\n      if (startPC) {\n        await startPeerConnection();\n      }\n    };\n\n    const startPeerConnection = async () => {\n      try {\n        const offer = await connection.createOffer();\n        send({\n          type: \"offer\",\n          offer,\n        });\n        await connection.setLocalDescription(offer);\n      } catch (err) {\n        console.error(err);\n      }\n    };\n\n    const onOffer = async (offer, remote) => {\n      remoteId = remote;\n      await connection.setRemoteDescription(new window.RTCSessionDescription(offer));\n\n      try {\n        const answer = await connection.createAnswer();\n        await connection.setLocalDescription(answer);\n        send({\n          type: \"answer\",\n          answer,\n        });\n      } catch (err) {\n        console.error(err);\n      }\n    };\n\n    const onAnswer = async (answer) =>\n      await connection.setRemoteDescription(new window.RTCSessionDescription(answer));\n\n    const onCandidate = async (candidate) =>\n      await connection.addIceCandidate(new window.RTCIceCandidate(candidate));\n\n    const onLeave = async () => {\n      remoteId = null;\n      setRemoteStream(null);\n      connection.close();\n      connection.onaddstream = null;\n      connection.onicecandidate = null;\n      startConnection();\n    };\n\n    if (room.length > 0) {\n      send({\n        type: \"enter\",\n        id,\n      });\n    } else {\n      // Error\n    }\n\n    const unsubscribe = () => {\n      connection.close();\n      connection.onaddstream = null;\n      connection.onicecandidate = null;\n      send({\n        type: \"leave\",\n      });\n    };\n    return unsubscribe;\n  }, [navigation, room]);\n\n  return (\n    <div className=\"app\">\n      <header className=\"App-header\">\n        <h1>Hi</h1>\n      </header>\n    </div>\n  );\n};\n// function App() {\n//   return (\n//     <div className=\"App\">\n//       <header className=\"App-header\">\n//         <img src={logo} className=\"App-logo\" alt=\"logo\" />\n//         <p>\n//           Edit <code>src/App.js</code> and save to reload.\n//         </p>\n//         <a\n//           className=\"App-link\"\n//           href=\"https://reactjs.org\"\n//           target=\"_blank\"\n//           rel=\"noopener noreferrer\"\n//         >\n//           Learn React\n//         </a>\n//       </header>\n//     </div>\n//   );\n// }\n\nexport default App;\n"]},"metadata":{},"sourceType":"module"}